PROMPT 15: ADVANCED FORENSICS (Malware DNA & Metadata Diffing)
Role: Senior Forensic Rust Engineer Target Path: /home/ransomeye/rebuild/core/forensics/Goal: Build the ransomeye-forensics crate.Context: Real-time detection (Phase 5) is fast but shallow. This module provides the "Deep Dive." It runs on low-priority background threads to perform heavy computations: Malware DNA (calculating Fuzzy Hashes to identify variants of known families) and Metadata Diffing (comparing system snapshots to find persistence mechanisms like new Registry keys or Services).

1. ğŸ›‘ HARD CONSTRAINTS (MUST OBEY)
Directory Standards:

Root: /home/ransomeye/rebuild/core/forensics/


Workspace: You must add "core/forensics" to the [workspace.members] list in the root Cargo.toml.

Dependencies (Strict):


tlsh: For Fuzzy Hashing (Locality Sensitive Hashing). MD5/SHA are BANNED for similarity checks because they are brittle.


rayon: For parallelizing heavy snapshot comparisons.


tokio: For the async background worker loop.


serde, serde_json: For struct serialization.


hex: For formatting hash output.

Security/Performance:


Non-Blocking: The DnaWorker MUST run on a dedicated, low-priority thread. It must never block the main tokio executor.


Zero Hardcoding: Configuration (e.g., MAX_DIFF_SIZE_BYTES) must be loaded from core/kernel config.

2. ğŸ“‚ DIRECTORY STRUCTURE & FILES
Create exactly this structure under /home/ransomeye/rebuild/core/forensics/:

Plaintext

core/forensics/
â”œâ”€â”€ Cargo.toml                  # Dependencies (tlsh, rayon, etc.)
â””â”€â”€ src/
    â”œâ”€â”€ lib.rs                  # Exports DnaWorker and Analysis traits
    â”œâ”€â”€ worker.rs               # The Async Background Worker (MPSC Channel)
    â”œâ”€â”€ dna/
    â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”œâ”€â”€ fuzzy.rs            # TLSH Implementation (The "DNA")
    â”‚   â”œâ”€â”€ entropy.rs          # Shannon Entropy Calculation
    â”‚   â””â”€â”€ features.rs         # PE Header / String Extraction stub
    â””â”€â”€ diffing/
        â”œâ”€â”€ mod.rs
        â”œâ”€â”€ engine.rs           # Generic Diffing Logic (New vs Old)
        â””â”€â”€ types.rs            # Snapshot Structs (Process, File, Net)
3. âš™ï¸ IMPLEMENTATION DETAILS
A. The Background Worker (src/worker.rs)
Struct: pub struct DnaWorker { queue: tokio::sync::mpsc::Receiver<AnalysisTask> }Logic:

Spawn a tokio::task::spawn_blocking loop (or a dedicated standard thread) to process tasks.

Consume: Pull AnalysisTask items from the channel.

Dispatch:

If AnalysisTask::Binary(data): Call dna::fuzzy::compute().

If AnalysisTask::Snapshot(old, new): Call diffing::engine::compare().


Output: Return a ForensicResult via a oneshot channel or publish to core/bus.

B. Malware DNA Engine (src/dna/)
Fuzzy Hashing (fuzzy.rs):

Library: Use the tlsh crate.

Function: pub fn compute_fingerprint(data: &[u8]) -> Result<String, DnaError>.


Goal: Generate a hash that allows RansomEye to say "This file is 98% similar to WannaCry" even if bits were changed.

Entropy (entropy.rs):

Function: pub fn shannon_entropy(data: &[u8]) -> f64.


Significance: If entropy > 7.5, flag the file as PACKED_OR_ENCRYPTED (highly suspicious for binaries).

C. Metadata Diffing Engine (src/diffing/)
Strategy: DO NOT diff raw RAM. Diff Metadata Snapshots.Structs (types.rs):

Rust

pub struct Snapshot {
    pub processes: Vec<ProcessInfo>,
    pub connections: Vec<NetInfo>,
    pub services: Vec<ServiceInfo>
}
Logic (engine.rs):


Parallel Compare: Use rayon to parallelize the comparison if lists are large (>10k items).

Identify: NewProcesses (present in New, missing in Old), TerminatedProcesses, NewListeners.


Alert Trigger: If a NewProcess is found in System32 AND authenticode_signed == false, return RiskLevel::Critical.

4. âœ… ACCEPTANCE CRITERIA

DNA Test: dna::fuzzy::compute() generates a valid TLSH hash for a dummy 1MB byte array.

Similarity Test: Comparing two byte arrays that differ by only 1 byte results in a very high TLSH similarity score (e.g., using tlsh::diff).


Non-Blocking Test: Submitting a heavy diff task (mocked sleep) to DnaWorker does not block the main thread (verified by timestamp checks).


Entropy Test: A random byte array returns entropy ~8.0; a zeroed array returns 0.0.


Build: cargo build -p ransomeye-forensics succeeds without warnings.