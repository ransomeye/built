PROMPT 26: STANDALONE DPI PROBE (High-Performance Sensor)
Role: Senior Network Engineer & Systems Architect Target Path: /home/ransomeye/rebuild/edge/dpi/

Goal: Build the ransomeye-dpi crate. Context: This is a high-throughput network sensor that performs packet capture (libpcap/AF_PACKET/AF_XDP), flow reassembly, and ML-based asset classification. It sits on SPAN ports to detect "C2 Beaconing" or "Data Exfiltration." Crucially, it must respect the CPU Pinning set by Phase 23 and the 3GB Disk Limit enforced by Phase 24.

1. ğŸ›‘ HARD CONSTRAINTS (MUST OBEY)
Directory Standards:

Root: /home/ransomeye/rebuild/edge/dpi/

Workspace: You must add "edge/dpi" to the [workspace.members] list in the root Cargo.toml.

Network Configuration:

Admin API: Port 9080 (Localhost Only).

Metrics: Port 9092 (Prometheus).

Core API: Read CORE_API_URL from Environment.

Performance & Tuning:

Driver Selection: Auto-detect traffic load.

Use AF_PACKET (Standard) for <1Gbps.

Use AF_XDP (Zero-Copy) for >1Gbps.

CPU Pinning: The service must strictly respect the /etc/systemd/system/ransomeye-dpi.service.d/affinity.conf generated by the System Tuner (Phase 23).

ML & Training (Updated):

Training Storage: STRICTLY CAP training artifacts at 3GB Disk Space (Enforced by Phase 24 Orchestrator).

Autolearn: incremental_trainer.py must be present and support SHAP explainability.

Data Integrity:

Privacy: Redact Credit Cards/SSNs if PROBE_PRIVACY_REDACT=strict.

Signed Uploads: All captured chunks must be signed before upload to Core.

2. ğŸ“‚ DIRECTORY STRUCTURE & FILES
Create exactly this structure under /home/ransomeye/rebuild/edge/dpi/:

Plaintext

edge/dpi/
â”œâ”€â”€ Cargo.toml                  # Dependencies (aya, pnet, tokio, etc.)
â”œâ”€â”€ build.rs                    # eBPF Compilation
â”œâ”€â”€ engine/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ capture.rs              # AF_PACKET / AF_XDP Abstraction
â”‚   â”œâ”€â”€ reassembly.rs           # TCP Stream Reassembly
â”‚   â”œâ”€â”€ privacy.rs              # PII Redaction Logic
â”‚   â””â”€â”€ buffering.rs            # Disk Buffer (Pending/Archived)
â”œâ”€â”€ ml/
â”‚   â”œâ”€â”€ classifier.rs           # ONNX Inference Wrapper
â”‚   â”œâ”€â”€ shap_gen.rs             # SHAP Value Calculation
â”‚   â””â”€â”€ training/
â”‚       â”œâ”€â”€ train_asset.py      # Python Training Script (3GB Disk Cap)
â”‚       â””â”€â”€ incremental.py      # Autolearn Logic
â”œâ”€â”€ transport/
â”‚   â”œâ”€â”€ client.rs               # mTLS Client
â”‚   â”œâ”€â”€ uploader.rs             # Chunk Uploader
â”‚   â””â”€â”€ receipt.rs              # Validates Server Signed Receipts
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ admin.rs                # Localhost Control API
â”‚   â””â”€â”€ metrics.rs              # Prometheus Exporter
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ traffic_gen.py          # Synthetic Traffic Generator
â”‚   â””â”€â”€ pcap_replay.rs          # Replay PCAP for testing
â””â”€â”€ tests/
    â”œâ”€â”€ unit/
    â””â”€â”€ integration/
3. âš™ï¸ IMPLEMENTATION DETAILS
A. Capture Engine (src/engine/capture.rs)
Logic:

Check PROBE_DRIVER env var.

Standard Mode: Use pnet or libpcap backend.

HighPerf Mode: Use aya (eBPF) + af_xdp for zero-copy.

Output: Stream FlowRecord structs to buffering.rs.

B. ML Classification (src/ml/classifier.rs)
Logic:

Load asset_model.onnx.

Features: Packet Sizes, Inter-arrival Times, Entropy.

Inference: Detect "C2 Beaconing", "Data Exfiltration", "Crypto Mining".

SHAP: Generate explanations for high-confidence detections (e.g., "Why is this flow flagged?").

C. Privacy Filter (src/engine/privacy.rs)
Logic:

Scan payloads using regex::bytes::RegexSet (pre-compiled).

Patterns: Credit Card Numbers (Luhn check), SSNs.

Action: Replace matches with [REDACTED].

D. System Integration
Systemd Generation:

Generate ransomeye-dpi.service.

Crucial: Include After=ransomeye-tuner.service to ensure CPU pinning is applied before the probe starts.

4. âœ… ACCEPTANCE CRITERIA
Capture Test: traffic_gen.py sends packets; pcap_replay.rs verifies they are captured and buffered correctly.

Privacy Test: A generated packet containing a fake SSN is logged as [REDACTED] in the output stream.

Training Check: The train_asset.py script runs successfully when invoked by the Phase 24 Orchestrator and does not exceed 3GB disk usage.

Pinning: The service process respects the CPU affinity mask set by the System Tuner (verified via taskset -p <pid>).

Build: cargo build -p ransomeye-dpi succeeds.